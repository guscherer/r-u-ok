name: R-U-OK CI/CD - Automated Testing

on:
  push:
    branches: 
      - master
      - main
      - develop
  pull_request:
    branches: 
      - master
      - main
  workflow_dispatch:  # Permite execução manual

jobs:
  test:
    name: Test R Package (R ${{ matrix.r-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        r-version: ['4.2.0', '4.5.2']
    
    steps:
      # 1. Checkout código
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. Setup R
      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}
          use-public-rspm: true
      
      # 3. Install system dependencies (Ubuntu)
      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev
      
      # 4. Cache R packages
      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ matrix.r-version }}-${{ hashFiles('DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-${{ matrix.r-version }}-
            ${{ runner.os }}-r-
      
      # 5. Install dependencies
      - name: Install R dependencies
        run: |
          install.packages(c("remotes", "rcmdcheck", "testthat"))
          remotes::install_deps(dependencies = TRUE, upgrade = "never")
        shell: Rscript {0}
      
      # 6. Check package
      - name: Check R package
        run: |
          rcmdcheck::rcmdcheck(
            args = c("--no-manual", "--as-cran"),
            error_on = "warning",
            check_dir = "check"
          )
        shell: Rscript {0}
      
      # 7. Run tests with coverage
      - name: Run tests
        run: |
          library(testthat)
          test_results <- test_dir("tests", reporter = "summary")
          print(test_results)
        shell: Rscript {0}
        continue-on-error: false
      
      # 8. Upload test results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-r${{ matrix.r-version }}
          path: check/
          retention-days: 7
      
      # 9. Test coverage (apenas Ubuntu + R latest)
      - name: Test coverage
        if: matrix.os == 'ubuntu-latest' && matrix.r-version == '4.5.2'
        run: |
          install.packages("covr")
          covr::package_coverage()
        shell: Rscript {0}

  lint:
    name: Lint R Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.5.2'
      
      - name: Install lintr
        run: install.packages("lintr")
        shell: Rscript {0}
      
      - name: Lint R files
        run: |
          library(lintr)
          lints <- lint_package()
          print(lints)
          # Fail if critical issues found
          if (length(lints) > 50) {
            stop("Too many lint issues (", length(lints), ")")
          }
        shell: Rscript {0}
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
      
      - name: Install dependencies
        run: install.packages(c("remotes"))
        shell: Rscript {0}
      
      - name: Check for secrets in code
        run: |
          # Verifica se há API keys expostas
          if grep -r "ZHIPU_API_KEY.*=" --include="*.R" --include="*.r" . ; then
            echo "WARNING: Possible API key exposure detected!"
            exit 1
          fi
          echo "✓ No exposed secrets detected"
        shell: bash
        continue-on-error: true
      
      - name: Validate security modules
        run: |
          # Testa se módulos de segurança existem
          required_files=(
            "R/input_validation.R"
            "R/file_validation.R"
            "R/code_sandbox.R"
            "R/ml_detection.R"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Security module missing: $file"
              exit 1
            fi
            echo "✓ Found: $file"
          done
          
          echo "✓ All security modules present"
        shell: bash

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.5.2'
      
      - name: Install dependencies
        run: |
          install.packages(c("remotes", "testthat"))
          remotes::install_deps(dependencies = TRUE)
        shell: Rscript {0}
      
      - name: Run integration tests
        run: |
          library(testthat)
          # Testa integração entre módulos
          test_file("tests/testthat/test-code-sandbox.R")
          test_file("tests/testthat/test-ml-detection.R")
          test_file("tests/testthat/test-input-validation.R")
        shell: Rscript {0}

  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [test, lint, security, integration]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "::notice::Build completed - Check individual jobs for details"
          echo "Tests: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Integration: ${{ needs.integration.result }}"
